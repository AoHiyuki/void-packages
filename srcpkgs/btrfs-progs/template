# Template file for 'btrfs-progs'
pkgname=btrfs-progs
version=5.11
revision=1
wrksrc="${pkgname}-v${version}"
build_style=gnu-configure
make_check_target=test
configure_args="--disable-backtrace --disable-python"
hostmakedepends="asciidoc pkg-config xmlto"
makedepends="acl-devel e2fsprogs-devel libzstd-devel lzo-devel"
checkdepends="acl-progs e2fsprogs tar xz which eudev grep"
short_desc="Btrfs filesystem utilities"
maintainer="Enno Boland <gottox@voidlinux.org>"
license="GPL-2.0-only, LGPL-3.0-or-later"
homepage="https://btrfs.wiki.kernel.org/index.php/Main_Page"
changelog="https://raw.githubusercontent.com/kdave/btrfs-progs/master/CHANGES"
distfiles="${KERNEL_SITE}/kernel/people/kdave/${pkgname}/${pkgname}-v${version}.tar.xz"
checksum=d41961b0a92160c80f894ad9a1882822889c2e1d084cbf3e08b8c214a5cf0137

pre_build() {
	if [ $CROSS_BUILD ]; then
		${BUILD_CC} ${BUILD_CFLAGS} kernel-lib/mktables.c -o mktables
	fi
}

pre_check() {
	# Requires losetup which is part of util-linux, but even with it installed it fails
	rm -rf -- tests/mkfs-tests/001-basic-profiles
	rm -rf -- tests/mkfs-tests/006-partitioned-loopdev
	rm -rf -- tests/mkfs-tests/017-small-backing-size-thin-provision-device
	# Requires fallocate from util-linux
	rm -rf -- tests/fsck-tests/025-file-extents
	# Requires mount from util-linux
	rm -rf -- tests/fsck-tests/012-leaf-corruption
	rm -rf -- tests/fsck-tests/013-extent-tree-rebuild
	rm -rf -- tests/fsck-tests/024-clear-space-cache
	rm -rf -- tests/fsck-tests/028-unaligned-super-dev-sizes
	rm -rf -- tests/fsck-tests/031-metadatadump-check-data-csum
	rm -rf -- tests/fsck-tests/033-lowmem-collission-dir-items
	rm -rf -- tests/fsck-tests/037-freespacetree-repair
	rm -rf -- tests/mkfs-tests/010-minimal-size
	rm -rf -- tests/mkfs-tests/012-rootdir-no-shrink
	rm -rf -- tests/mkfs-tests/018-multidevice-overflow
	# Most of these tests fail
	rm -rf -- tests/misc-tests
	rm -rf -- tests/cli-tests
	rm -rf -- tests/convert-tests
}

post_install() {
	vinstall btrfs-completion 644 /usr/share/bash-completion/completions btrfs
}

libbtrfs_package() {
	short_desc+=" - btrfs library"
	pkg_install() {
		vmove "usr/lib/libbtrfs.so.*"
	}
}

libbtrfs-devel_package() {
	short_desc+=" - libbtrfs development files"
	depends="libbtrfs>=${version}_${revision}"
	pkg_install() {
		vmove usr/include/btrfs
		vmove usr/lib/libbtrfs.a
		vmove usr/lib/libbtrfs.so
	}
}

libbtrfsutil_package() {
	short_desc+=" - btrfsutil library"
	pkg_install() {
		vmove "usr/lib/libbtrfsutil.so.*"
	}
}

libbtrfsutil-devel_package() {
	depends="libbtrfsutil-${version}_${revision}"
	short_desc+=" - libbtrfsutil development files"
	pkg_install() {
		vmove usr/include/btrfsutil.h
		vmove usr/lib/libbtrfsutil.a
		vmove usr/lib/libbtrfsutil.so
	}
}

# Template file for 'Vieb'
pkgname=Vieb
version=5.0.0
revision=1
_electron_ver=12
hostmakedepends="yarn nodejs python3 pkg-config app-builder libnotify-devel"
makedepends="electron${_electron_ver}"
depends="electron${_electron_ver} c-ares ffmpeg gtk+3 http-parser libevent
 libvpx6 libxslt minizip nss re2 snappy"
short_desc="Vim inspired Electron browser"
maintainer="FollieHiyuki <folliekazetani@protonmail.com>"
license="GPL-3.0-or-later"
homepage="https://vieb.dev/"
distfiles="https://github.com/Jelmerro/Vieb/archive/${version}.tar.gz"
checksum=d96b08be225e2c89a6fd48a4eeee032f7693210b3e05091185f1aa92b9bc904c

export USE_SYSTEM_APP_BUILDER=true

do_configure() {
	yarn install
	local carch=x64
	case "$XBPS_TARGET_MACHINE" in
		i686*) carch=ia32 ;;
	esac
	npm_config_arch=$carch \
		yarn upgrade electron@"$(</usr/lib/electron${_electron_ver}/version)" \
			--non-interactive
}

do_build() {
	export NODE_ENV=production
	yarn run electron-builder --linux --x64 --dir \
		-c.electronDist=/usr/lib/electron${_electron_ver} \
		-c.electronVersion="$(</usr/lib/electron${_electron_ver}/version)"
}

do_install() {
	vinstall "${FILESDIR}/vieb.desktop" 644 usr/share/applications
	vbin "${FILESDIR}/vieb"
	for i in 16 24 48 64 96 128 256 512 1024; do
		vinstall ${wrksrc}/app/img/icons/${i}x${i}.png 644 /usr/share/icons/hicolor/${i}x${i}/apps/ vieb.png
	done
	vinstall "dist/linux-unpacked/resources/app.asar" 644 /usr/lib vieb.asar
}
